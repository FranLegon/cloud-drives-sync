#### **1. Project Overview & Persona**

You are an expert Go developer specializing in building robust, command-line tools that interact with cloud storage APIs.

Your task is to generate the code for a Go binary named `cloud-drives-sync`. This tool will manage and synchronize files across a user's multiple Google Drive, Microsoft OneDrive for Business, and Telegram accounts. The tool is architected around the concept of a single **main account** (Google provider), which acts as the primary sync target, and one or more **backup accounts** (from any provider), used for storage expansion and data redundancy.

The primary goals are to free main account, de-duplicate files, ensure data is mirrored across providers and balance storage usage between backup accounts.

#### **2. Core Operational Constraint: The "Sync Folder"**

The application must only interact with files and folders contained within specific root folders:

**Soft Deletion:**
- A special folder `sync-cloud-drives-aux/soft-deleted` exists for soft-deleted files. Files here are excluded from standard sync but enforced if present in other providers.

**Google Drive:**
- A single folder named `sync-cloud-drives` resides in the main account.
- The main account owns all folders within this structure.
- Backup accounts own the files but do not own folders.

**Microsoft OneDrive for Business:**
- A single folder named `sync-cloud-drives` resides in each backup account.
- Each backup account owns its own `sync-cloud-drives` folder and all subfolders within it.
- Files are distributed across backup accounts. To maintain a consistent directory structure across all accounts, if a file is owned by Account A, Account B will contain a shortcut to that file in the corresponding location within its own `sync-cloud-drives` structure.
- Folder owner is always the file owner in OneDrive.

**Telegram:**
- Heavily relies on metadata.db and message caption to track files stored in Telegram, as Telegram does not have a folder structure.
- Files bigger than Telegram's limits get uploaded as multiple parts, each tracked in the database.

*   **Isolation:** The tool must never read, list, modify, or delete any file or folder outside of the designated `sync-cloud-drives` directories.
*   **Pre-flight Check:** Before executing any command that interacts with the cloud, the tool must perform a "pre-flight check":
    *   **Google Drive:** Verifies that exactly one folder named `sync-cloud-drives` is owned by the main account. It will search all active folders and explicitly ignore any folders that are marked as trashed/in the recycle bin. If the folder is found but is not in the root directory, it will be moved there. If more than one active folder with this name are found, the program must abort with a clear error message instructing the user to resolve the ambiguity manually.
    *   **Microsoft OneDrive:** Verifies that exactly one folder named `sync-cloud-drives` exists in each backup account. If more than one active folder with this name are found in a backup account, the program must abort with a clear error message instructing the user to resolve the ambiguity manually.
    *   **Telegram:** Verifies that the Telegram account is accessible and ready for file operations.

#### **3. Architecture & Design Principles**

*   **Modularity:** Structure the code into logical packages (e.g., `cmd`, `google`, `microsoft`, `telegram`, `database`, `crypto`). All database and cloud provider interactions shall be implemented behind interfaces to allow for future extensions (such as implementing new providers).
*   **Concurrency:** Use concurrency where it provides a performance benefit without risk, such as making independent, read-only API calls to multiple accounts simultaneously. All database write operations must be performed sequentially from a single thread or goroutine to prevent race conditions and ensure data integrity.
*   **Configuration Management:** All configuration data (API credentials, user tokens) will be stored in a single encrypted file: `config.json.enc`, located in the same directory as the binary.
*   **Security:**
    *   The `config.json.enc` file will be encrypted using AES-256 GCM.
    *   The encryption key will be derived from a user-provided master password using the Argon2id key derivation function. The binary will require this master password on every execution to decrypt the configuration.
    *   A unique, cryptographically secure salt will be generated on the first run and stored in a file named `config.salt`. If this file already exists, it will be used for all subsequent key derivations.
*   **API Interaction:**
    *   For each provider, prefer using the official Golang SDK/package when available. Use REST API directly as a fallback when SDK errors or it's functionality is insufficient or unavailable.
    *   Use streaming for all file uploads and downloads to minimize memory consumption.
    *   Implement exponential backoff and retry mechanisms for all API calls to handle transient network errors and rate limiting gracefully.
*   **Database:**
    *   Use an encrypted SQLite database located at `metadata.db`. The database file itself will be encrypted using a library like SQLCipher.
    *   **Direct Access:** The decryption password for the database will be the user's raw master password. This allows the user to access and query the database outside of the CLI using a compatible database tool. The database login user will be `owner`.
*   **Logging and Exit Codes:**
    *   Log all major actions, successes, and detailed errors to the console. Logs should be prefixed with tags when appropriate (e.g., `[Google]`, `[Microsoft]`, `[Telegram]`, `[main.user@gmail.com]`).
    *   The application will exit with a status code of `0` on success and a non-zero status code on any error, making it suitable for scripting.
    *   **Metadata Sync:**
        *   **Upload:** All commands that alter `metadata.db` (e.g., `init`, `get-metadata`, `sync-providers`, `remove-duplicates*`, `balance-storage`, `free-main`) must upload the `metadata.db` file to a dedicated folder named `sync-cloud-drives/sync-cloud-drives-aux` in the main account (Google) and all backup accounts (Google/OneDrive/Telegram) at the end of successful execution.
        *   **Download:** All commands that require `metadata.db` must first check for the file locally. If it is missing, the tool must attempt to download it from `sync-cloud-drives/sync-cloud-drives-aux/metadata.db`.
        *   **Download Priority:** 
            1.  Local file system.
            2.  Google Drive (Main Account).
            3.  Microsoft OneDrive (Backup Accounts).
            4.  Telegram (Backup Account).
        *   If the file is not found in any location, the command (unless it is `init`) should fail with a clear error.

#### **4. Configuration Schema**

*`config.json` (before encryption):*
```json
{
  "google_client": {
    "id": "YOUR_GCP_CLIENT_ID",
    "secret": "YOUR_GCP_CLIENT_SECRET"
  },
  "microsoft_client": {
    "id": "YOUR_AZURE_CLIENT_ID",
    "secret": "YOUR_AZURE_CLIENT_SECRET"
  },
  "telegram_client": {
    "api_id": "YOUR_TELEGRAM_API_ID",
    "api_hash": "YOUR_TELEGRAM_API_HASH",
    "phone": "YOUR_PHONE_NUMBER"
  },
  "users": [
    {
      "provider": "Google",
      "email": "main.user@gmail.com",
      "is_main": true,
      "refresh_token": "..."
    },
    {
      "provider": "Google",
      "email": "backup1@gmail.com",
      "is_main": false,
      "refresh_token": "..."
    },
    {
      "provider": "Microsoft",
      "email": "main.user@company.com",
      "is_main": false,
      "refresh_token": "..."
    },
    {
      "provider": "Microsoft",
      "email": "work.backup@company.com",
      "is_main": false,
      "refresh_token": "..."
    },
    {
      "provider": "Telegram",
      "phone": "+1234567890",
      "is_main": false,
      "session_data": "..."
    }
  ]
}
```

**Note:** The database schema is defined as follows:

```sql
CREATE TABLE IF NOT EXISTS files (
    id TEXT PRIMARY KEY,
    path TEXT NOT NULL,
    name TEXT NOT NULL,
    size INTEGER NOT NULL,
    mod_time INTEGER NOT NULL,
    hash TEXT,
    status TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS replicas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_id TEXT NOT NULL,
    provider TEXT NOT NULL,
    account_id TEXT NOT NULL,
    native_id TEXT NOT NULL,
    native_hash TEXT,
    status TEXT NOT NULL,
    FOREIGN KEY(file_id) REFERENCES files(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS replica_fragments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    replica_id INTEGER NOT NULL,
    sequence_number INTEGER NOT NULL,
    native_fragment_id TEXT NOT NULL,
    FOREIGN KEY(replica_id) REFERENCES replicas(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS folders (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    path TEXT NOT NULL,
    provider TEXT NOT NULL,
    user_email TEXT,
    user_phone TEXT,
    parent_folder_id TEXT,
    owner_email TEXT
);
```

---

#### **5A. Detailed Functionality (Command-Line commands)**

*   **`init`**
    *   Handles first-time setup: prompts for a master password, generates `config.salt` (if absent), creates the encrypted `config.json.enc` after prompting for client credentials, creates the encrypted `metadata.db` and adds **main account** (initiating an OAuth 2.0 flow by starting a local web server.)
    *   **OAuth Scopes:** 
        *   Google: Requests `https://www.googleapis.com/auth/drive` and `https://www.googleapis.com/auth/userinfo.email`.
        *   Microsoft: Requests `files.readwrite.all`, `user.read`, and `offline_access` for OneDrive for Business.
        *   Telegram: Uses Telegram API authentication with phone number and verification code.
    *   **Microsoft Account Types:** The Azure App Registration must be configured to support "Accounts in any organizational directory (Any Azure AD directory - Multitenant)" for OneDrive for Business.
    *   After adding a Google main account, it creates the `sync-cloud-drives` folder in that account's root if it doesn't exist.
    *   Subsequent runs of `init` allows updating client credentials or main account.

*   **`add-account`**
    *   Adds a **backup account** to a provider.
    *   Exits with an error if no main account exists.
    *   Initiates OAuth 2.0 flow by starting a local web server.
    *   **Google Drive:** Upon successful authorization, the main account shares its `sync-cloud-drives` folder with the new backup account, granting "editor" permissions.
    *   **Microsoft OneDrive:** Upon successful authorization, creates a `sync-cloud-drives` folder in the backup account's root if it doesn't exist.
    *   **Telegram:** Allows adding Telegram account for backup storage purposes.

*   **`get-metadata`**
    *   After passing the pre-flight checks, it recursively scans the designated sync folders for every account.
    *   **Google Drive:** Scans the `sync-cloud-drives` folder and all shared content within it.
    *   **Microsoft OneDrive:** Scans the `sync-cloud-drives` folder in each account, handling both actual files and shortcuts to files owned by other accounts.
    *   **Telegram:** Lists all files stored in the Telegram account.
    *   For each found file, it updates the `files` (logical) and `replicas` (physical) tables:
        *   **replicas:** Stores the provider-specific `native_id`, `native_hash` (MD5 for Google, SHA1 for OneDrive), `account_id`, and `provider`.
        *   **files:** logical entry derived from path, name, size and mod_time.
    *   **Telegram:** Retrieves `file_unique_id` (mapped to `native_id`) and fragments if split.
    *   Updates the file, replica, and folder records in the local encrypted database.

*   **`check-for-duplicates`**
    *   First, runs the `get-metadata` logic to ensure the local DB is up-to-date.
    *   Then, queries the DB to find records with identical file hashes *within the same provider*.
    *   Prints a list of duplicate files grouped by hash.

*   **`remove-duplicates`**
    *   Performs the `check-for-duplicates` action. For each set of duplicates, it prompts the user to select which file(s) to delete.

*   **`remove-duplicates-unsafe`**
    *   Performs the `check-for-duplicates` action. For each set of duplicates, it automatically deletes all copies except the one with the oldest creation date.

*   **`share-with-main`**
    *   A utility command to repair permissions.
    *   **Google Drive:** After passing the pre-flight check, it verifies that every backup account has "editor" access to the main account's `sync-cloud-drives` folder and re-applies the permission if it is missing.

*   **`sync-providers`**
    *   Ensures metadata is current by running the `get-metadata` logic.
    *   **Goal:** Make file content within sync folders consistent across Google Drive, Microsoft OneDrive, and Telegram.
    *   **Logic:** Compares file sets using normalized paths and file hashes. If a file is missing on one side, it's uploaded, replicating the directory structure. If a file name exists at the same path but with a different hash, it's treated as a conflict, and the incoming file is renamed with a `_conflict_YYYY-MM-DD_hh-mm-ss` suffix before upload/transfer.
    *   **Soft Deletion:** The folder `sync-cloud-drives-aux/soft-deleted` is treated specially. Files in this folder are not synced to other providers if missing. If a file is found in `sync-cloud-drives-aux/soft-deleted` for one provider and in another folder for another provider, it is moved to `sync-cloud-drives-aux/soft-deleted` for all providers.
    *   **Telegram Handling:** Files can be pushed to Telegram as backups but consider its limitations (file size limits, access patterns).

*   **`balance-storage`**
    *   After passing the pre-flight check, it checks the storage quota for every configured account.
    *   If any single backup account is over 95% full, it identifies the largest files in that account's sync folders.
    *   It then moves these files, one by one, to a backup account of the **same provider** with the most available free space until the source account is below the 90% threshold.
    *   **Google Drive:** Will first attempt a native API ownership transfer. If that fails, is unsupported or requires manually accepting the transfership, it will fall back to a download/re-upload/delete process, ensuring metadata is preserved. Never delete original until reupload is confirmed.
    *   **Microsoft OneDrive:** download/re-upload/delete process.
    *   **Telegram:** Storage balancing doesn't apply as there's no max quota.

*   **`free-main`**
    *   Transfers all files from main account's sync folder to its associated backup accounts (Google only).
    *   For each file, it chooses the backup account with the most available free space. It will throw an error if the backup accounts lack sufficient combined space.
    *   Uses the same ownership transfer/fallback logic as `balance-storage`.

*   **`check-tokens`**
    *   Iterates through all refresh tokens in the config. For each, it attempts a simple, read-only API call. It reports any tokens that have expired or been revoked, indicating which account needs re-authentication.
    *   Includes Telegram session validation.

*   **`delete-unsynced-files`**
    *   Deletes all files in backup accounts that are not inside the `sync-cloud-drives` folder or its subfolders.
    *   **Goal:** Clean up backup accounts to ensure they only contain synced data.
    *   **Logic:** Iterates through all backup accounts. For each account, lists all files and folders in the root directory. Any item that is not the designated sync folder (e.g., `sync-cloud-drives`) is deleted.
    *   **Safety:** Respects the `--safe` flag to perform a dry run.

*   **`help`**
    *   Lists all available commands, their purpose, and example usage.

#### **5B. Detailed Functionality (Command-Line flags)**

*   **`--safe`, `-s`**
    *   A modifier flag that can be used with any state-changing command (e.g., `remove-duplicates-unsafe --safe`).
    *   When active, no write, delete, or permission-change operations are sent to the cloud providers.
    *   Instead, the tool will print a detailed log of what actions *would* have been taken. Example: `[DRY RUN] DELETE GDrive file 'duplicate.txt' (FileID: xyz) from account 'backup@gmail.com'`.
    *   Read-only operations and local DB modifications are still allowed.

*   **`--help`, `-h`**
    *   A modifier flag that can be used with any command (e.g., `cloud-drives-sync free-main --help`) to get more information on how it works.

*   **`--password`, `-p`**
    *   A global flag that allows the user to provide the master password non-interactively for scripting purposes. If omitted, the tool will prompt for the password interactively.

*   **`--json`, `-j`**
    *   Flag specific to init command: allows to pass json as string containing all client credentials instead of prompting interactively.

*   **`--getjson`, `-g`**
    *   Flag specific to init command: after prompting for client credentials, outputs the equivalent json string to stdout for easier scripting.

#### **6. Provider-Specific Notes**

**Google Drive:**
- Main account owns folders; backup accounts own files.
- Single `sync-cloud-drives` folder shared among all accounts.

**Microsoft OneDrive for Business:**
- Each backup account owns its own `sync-cloud-drives` folder.
- Folder owner is always the file owner.
- Consistency is maintained via shortcuts. If Account A owns a file, Account B holds a shortcut to it.
- Each backup account effectively has a full view of the directory structure via a mix of owned files and shortcuts.

**Telegram:**
- Subject to Telegram API file size limits and rate limits.
- Files stored in dedicated channel called `sync-cloud-drives`.
- Each file is uploaded as a message with the file as an attachment and a caption containing metadata as json (e.g. 1, `{"file_name":"bigfile.db","folder_path":"/examplefolder", "calculated_id":"ihrstfh45fbkeb", "split": true, "part": 1, "total_parts": 3, "soft-deleted": false}`, e.g. 2, `{"file_name":"smallfile.jpg", "folder_path":"/examplefolder/innerfolder", "calculated_id":"smallfile.db-1564", "split": false, "soft-deleted": true}`).
- If more than one active channel with this name are found, the program must abort with a clear error message instructing the user to resolve the ambiguity manually.
- Files larger than Telegram's limits (2 GB) are split into multiple parts, each tracked in the local metadata database.
- System messages such as "channel created", "user joined", etc., must be ignored.

#### **7. Expected Response**

This must be a fully-implemented, production-ready project. There must be absolutely no TODOs, stubs, or placeholders. The coding agent will implement the complete Go project based on this v10 specification.
