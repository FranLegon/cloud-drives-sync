# Code Generation Bulletpoints for cloud-drives-sync v9

This file contains ordered code generation prompts for a coding agent. Each task should be implemented sequentially, building upon previously completed functionality.

---

## Phase 1: Foundation & Core Infrastructure

### 1. Project Setup & Dependencies
Set up the Go project structure with proper module initialization. Install all dependencies listed in `dependencies_v9.txt`. Create the basic directory structure following Go best practices: `cmd/`, `internal/` packages including `model/`, `logger/`, `crypto/`, `config/`, `api/`, `database/`, `auth/`, `google/`, `microsoft/`, `telegram/`, and `task/`.

### 2. Core Data Models
Implement the core data structures in `internal/model/model.go`. Define structs for File, Folder, User (supporting Google, Microsoft, and Telegram), and any other domain entities needed. Include proper field tags for JSON serialization.

### 3. Logging System
Create a standardized logging system in `internal/logger/logger.go` that supports tagged output (e.g., `[Google]`, `[Microsoft]`, `[Telegram]`, `[user@email.com]`). Implement log levels (info, warning, error) and console formatting.

### 4. Cryptography Module
Implement encryption/decryption utilities in `internal/crypto/crypto.go`. Include Argon2id key derivation from master password and salt, AES-256 GCM encryption/decryption for config file, and salt generation/persistence to `config.salt` file.

---

## Phase 2: Configuration & Database

### 5. Configuration Management
Implement configuration handling in `internal/config/config.go`. Define the config structure matching the JSON schema (Google client, Microsoft client, Telegram client, users array). Implement functions to load/save encrypted `config.json.enc`, manage the master password, and validate configuration data.

### 6. Database Layer
Create the encrypted SQLite database layer in `internal/database/database.go`. Implement SQLCipher integration with master password authentication. Design and implement appropriate schema for files and folders tables supporting Google Drive, Microsoft OneDrive, and Telegram. Include database initialization, connection management, and CRUD operations.

---

## Phase 3: Authentication & API Interfaces

### 7. Cloud Client Interface
Define the common CloudClient interface in `internal/api/client.go`. Specify methods needed across all providers: file operations, folder operations, permissions management, quota checking, metadata retrieval, and pre-flight checks.

### 8. OAuth 2.0 Flow
Implement OAuth 2.0 authentication in `internal/auth/oauth.go`. Create local callback server for authorization code exchange. Handle Google Drive and Microsoft OneDrive authentication flows with appropriate scopes. Implement state parameter validation for security.

### 9. Token Management
Create token source management in `internal/auth/token.go`. Implement automatic token refresh using stored refresh tokens. Handle token expiration and renewal. Provide token validation functionality.

---

## Phase 4: Provider Implementations

### 10. Google Drive Client
Implement the Google Drive client in `internal/google/client.go`. Implement CloudClient interface for Google Drive API. Handle the "main account owns folders, backup accounts own files" architecture. Implement file/folder operations, sharing permissions, ownership transfers, quota checks, and the pre-flight check for `synched-cloud-drives` folder.

### 11. Microsoft OneDrive Client  
Implement the Microsoft OneDrive for Business client in `internal/microsoft/client.go`. Implement CloudClient interface for Microsoft Graph API. Handle the "multiple sync folders, one per backup account" architecture. Support `synched-cloud-drives-N` folder naming scheme. Implement file/folder operations respecting "folder owner = file owner" constraint, sharing permissions, quota checks, and pre-flight checks for all backup folders.

### 12. Telegram Client
Implement the Telegram storage client in `internal/telegram/client.go`. Implement CloudClient interface (or adapted version) for Telegram API. Handle file upload/download via Telegram's Saved Messages or dedicated channel. Implement file metadata tracking, storage in Telegram, file size limit handling, and session management.

---

## Phase 5: Business Logic & Task Orchestration

### 13. Metadata Synchronization
Implement metadata gathering logic in `internal/task/task_runner.go`. Create functionality to scan all sync folders across all providers. Handle provider-native hash retrieval. Implement fallback hash calculation (SHA-256) for files without native hashes. Update database with file and folder information.

### 14. Duplicate Detection & Management
Extend task runner with duplicate file detection. Implement query logic to find files with identical hashes within same provider. Create interactive duplicate removal (prompting user). Implement unsafe automatic duplicate removal (keeping oldest).

### 15. Permission Management
Implement the share-with-main functionality. For Google: ensure backup accounts have editor access to main account's folder. For Microsoft: verify all backup folders are shared with main account. Implement permission repair/re-application logic.

### 16. Cross-Provider Synchronization
Implement sync-providers functionality. Compare files across Google, Microsoft, and Telegram using normalized paths and hashes. Upload missing files to other providers with directory structure replication. Handle file conflicts with rename strategy. Consider Telegram's limitations (file size, access patterns).

### 17. Storage Balancing
Implement balance-storage functionality. Check quota for all accounts (95% threshold). Identify largest files in over-quota accounts. Move files to same-provider backup accounts with most free space (90% target). Handle Google ownership transfer vs. download/upload fallback. Respect OneDrive folder ownership constraints.

### 18. Main Account Clearing
Implement free-main functionality. Transfer all files from main account to backup accounts. Choose backup account with most free space for each file. Validate sufficient combined backup storage. Adapt logic for OneDrive's different ownership model.

---

## Phase 6: Command-Line Interface

### 19. CLI Root & Framework
Implement the root command in `cmd/root.go`. Set up Cobra command framework. Implement master password prompt at startup. Handle global flags (--safe, --help). Implement pre-flight check invocation.

### 20. Init Command
Implement `cmd/init.go`. Handle first-time setup: password, salt generation, config creation, database initialization. Support adding main accounts with OAuth flow. Create `synched-cloud-drives` for Google main accounts. Configure OneDrive for Business main accounts.

### 21. Add Account Command
Implement `cmd/addAccount.go`. Add backup accounts for Google and Microsoft (require existing main account). Create and share `synched-cloud-drives-N` folders for OneDrive backup accounts. Share Google main folder with backup accounts. Support adding Telegram account.

### 22. Get Metadata Command
Implement `cmd/getMetadata.go`. Invoke metadata synchronization logic. Scan all provider sync folders. Update local database. Display progress and summary.

### 23. Duplicate Management Commands
Implement `cmd/checkForDuplicates.go`. Display duplicate files grouped by hash. Implement `cmd/removeDuplicates.go` for interactive deletion. Implement `cmd/removeDuplicates.go` (unsafe variant) for automatic deletion.

### 24. Share With Main Command
Implement `cmd/shareWithMain.go`. Invoke permission repair logic. Verify and fix sharing permissions across all providers.

### 25. Sync Providers Command
Implement `cmd/syncProviders.go`. Invoke cross-provider synchronization logic. Display sync progress, conflicts, and summary.

### 26. Balance Storage Command
Implement `cmd/balanceStorage.go`. Invoke storage balancing logic. Display quota information, file movements, and results.

### 27. Free Main Command
Implement `cmd/freeMain.go`. Invoke main account clearing logic. Display transfer progress and results.

### 28. Check Tokens Command
Implement `cmd/checkTokens.go`. Validate all refresh tokens and Telegram session. Report expired or revoked tokens. Provide re-authentication guidance.

---

## Phase 7: Final Integration & Polish

### 29. Main Entry Point
Implement `main.go`. Wire up root command execution. Handle exit codes properly. Ensure clean initialization flow.

### 30. Error Handling & Edge Cases
Review and enhance error handling across all modules. Implement proper error messages for all failure scenarios. Handle network timeouts, API rate limits, and transient errors with retry logic. Validate all user inputs. Handle edge cases (empty folders, very large files, special characters in names).

### 31. Safe Mode (Dry Run)
Implement --safe flag functionality across all state-changing commands. Ensure no actual cloud operations occur in safe mode. Display detailed "would perform" logs for all operations. Allow database reads and logging.

### 32. Documentation & Help
Implement comprehensive help command. Add detailed help text for each command. Include usage examples. Document flag options. Create inline documentation comments.

### 33. Testing & Validation
Implement unit tests for critical components (crypto, config, database). Create integration tests for API clients. Test OAuth flow. Validate database operations. Test concurrent operations safety. Verify safe mode functionality.

---

## Notes for Coding Agent

- Implement each task completely before moving to the next.
- Ensure no TODOs, stubs, or placeholders remain.
- Follow Go best practices and idiomatic patterns.
- Use interfaces for extensibility.
- Handle errors explicitly and meaningfully.
- Log important operations with appropriate tags.
- Test each component as it's built.
- Respect the architectural constraints described in requirements_v9.txt.
- Pay special attention to provider-specific behaviors (Google's ownership model, OneDrive's folder constraints, Telegram's limitations).
